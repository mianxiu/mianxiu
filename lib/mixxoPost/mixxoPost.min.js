const mixxoPost=function(e){let t,n,a,s,r;e.init=function(e){t=e.appId,n=e.appKey,a=""===e.adminNick?"admin":e.adminNick,s=""===e.gravatarCDN?"//gravatar.loli.net/avatar/":e.gravatarCDN,r=""===e.md5CDN?"//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js":e.md5CDN,i()};let i=()=>{if(!AV.applicationId){var{Query:e,User:r}=AV;AV.init(t,n)}const i=function(e){return document.querySelector(e)},l=(e,t)=>{Array.prototype.map.call(e,e=>e.style=t)},o=e=>{const t=document.querySelectorAll(".mpr-delete");e?l(t,"display:inline-block"):l(t,"")};var c=AV.Object.extend("Todo");let m=function(e,t,n,a,s,r,l,o){var m=new c;m.set("usernick",e),m.set("mail",t),m.set("website",n),m.set("comments",a),m.set("url",s),m.set("headImgID",r),m.save().then(function(e){let t=e.attributes;i("#mp-post-lists").insertAdjacentHTML("afterbegin",v(Date.parse(e.createdAt),t.usernick,g(t.usernick),e.id,e.id,"",t.comments,t.usernick,e.className,t.headImgID,u.deleteControl()))},function(e){})};var p=AV.Object.extend("Floor");let d=function(e,t,n,a,s,r,i,l,o){var c=new p;c.set("usernick",e),c.set("mail",t),c.set("website",n),c.set("comments",a),c.set("parentId",s),c.set("url",window.location.pathname),c.set("headImgID",r),c.set("re",i),c.save().then(function(e){let t=AV.Object.createWithoutData("Todo",s);t.set("hasReply",!0),t.save();let n=e.attributes;document.getElementById(n.parentId).insertAdjacentHTML("beforeend",v(Date.parse(e.createdAt),n.usernick,g(n.usernick),n.parentId,e.id,n.re,n.comments,n.usernick,e.className,n.headImgID,u.deleteControl()))},function(e){})};const u={getCurrentUser:function(){return!!AV.User.current()},deleteControl:function(){return console.log(this.getCurrentUser()),1==this.getCurrentUser()?"delete":""},init:function(){!0===this.getCurrentUser()&&(i("#mp-comments-panel").innerHTML+='\n                 <div class="mp-admin-panel">\n                 <span>🔑 Logout</span>\n                 </div>',i("#mp-comments-panel").addEventListener("click",e=>{console.log("退出登录"),AV.User.logOut(),i("#mp-comments-panel").removeChild(i(".mp-admin-panel")),o(!1)}))}},g=function(e){return e===a?'<span class="mp-writer">writer</span>':""};let v=function(e,t,n,a,r,i,l,o,c,m,p){let d=`<ul class="mp-reply" id="${a}"></ul>`;return`<li class="mp-post-li"><div class="mp-post-body">\n                                    <div class="headimg" style="background-image:url('${s+m}')"></div>\n                                    <div>\n                                    <div class="mpr-header" data-date="${e}">\n                                        <span class="mpr-nick">${t}${n}</span>\n                                        <span class="mpr-date">${function(e){let t=new Date(e),n=Date.now()-e;return n<6e4?parseInt(n/1e3)+"秒前":n<36e5?parseInt(n/6e4)+"分钟前":n<864e5?parseInt(n/36e5)+"小时":n<1728e5?"昨天 "+t.getHours()+":"+t.getMinutes():t.getFullYear()+"年"+t.getMonth()+"1月"+t.getDay()+"日"}(e)}<span>\n                                    </div>\n                                    <div class="mpr-body" ><span>${i} </span>${l}</div>\n                                    <div class="mpr-footer">\n                                    <div parent-id="${a}" obj-id="${r}">\n                                    <span class="mpr-reply"  at="${o}">reply</span>\n                                    <span class="mpr-delete" class-name="${c}">${p}</span>\n                                    </div>\n                                    </div>\n                                    </div>\n                                    </div>\n                                    ${d}\n                                    </li>`};const y=function(e){let t=new AV.Query("Floor");t.contains("parentId",e),t.find().then(t=>{for(let n of t){let t=n.attributes;document.getElementById(e.toString()).innerHTML+=`\n                ${v(Date.parse(n.createdAt),t.usernick,g(t.usernick),e,n.id,t.re,t.comments,t.usernick,n.className,t.headImgID,u.deleteControl())}\n                `}o(!0)})};var f=new AV.Query("Todo");const b=()=>{let e=document.querySelectorAll(".mp-info");Array.prototype.map.call(e,e=>{e.target;""!==e.value&&(e.parentNode.children[0].classList.add("mp-label-trans"),e.classList.add("mp-ui-pt"))})};!function(){function e(e,t){let n=document.getElementById(t);n.parentNode.children[0].classList.add("mp-label-trans"),n.classList.add("mp-ui-pt")}u.init(),function(e){f.contains("url",e),f.descending("createdAt"),f.find().then(e=>{i("#mp-comments-num > span").innerText=e.length,i("#mp-post-lists").addEventListener("click",e=>{let t=e.target.parentNode.getAttribute("parent-id"),n=i(".mixxo-post");if("mpr-reply"===e.target.className){let a=e.target.getAttribute("at"),s=""!==a?"@"+a:"";n.setAttribute("parent-id",t),n.setAttribute("re",s),n.setAttribute("type","reply"),n.classList.add("mixxo-post-reply"),i("#mp-overlay").classList.add("mp-overlay"),i(".mp-reply-tips").style.display="flex",i(".mp-reply-tips").innerHTML=e.target.parentNode.parentNode.parentNode.parentNode.innerHTML}"mpr-delete"===e.target.className&&(n.classList.add("mixxo-post-delete"),i(".mp-delete-confirm").insertAdjacentHTML("beforeend",e.target.parentNode.parentNode.parentNode.parentNode.innerHTML.replace(/mpr\-reply/g,"mpr-cancel").replace(/reply/g,"cancel")),i(".mp-delete-confirm").style.display="flex",i("#mp-overlay").classList.add("mp-overlay"),i(".mp-delete-confirm").addEventListener("click",e=>{let t=e.target.className;if("mpr-delete"===t){let t=e.target.getAttribute("class-name"),n=e.target.parentNode.getAttribute("obj-id"),a=document.getElementById(e.target.parentNode.getAttribute("parent-id")).parentNode;AV.Object.createWithoutData(t,n).destroy().then(function(e){console.log("delete"),i(".mp-overlay").click(),a.remove()},function(e){})}else"mpr-cancel"===t&&i(".mp-overlay").click()}))}),i("#mp-overlay").addEventListener("click",e=>{i(".mixxo-post").setAttribute("type","comment"),i(".mixxo-post").classList.remove("mixxo-post-reply"),i("#mp-overlay").classList.remove("mp-overlay"),i(".mp-delete-confirm").style.display="",i(".mp-delete-confirm").innerHTML="",i(".mp-reply-tips").style.display="",i(".mp-reply-tips").innerHTML=""});for(let t of e){let e=t.attributes,n=`${v(Date.parse(t.createdAt),e.usernick,g(e.usernick),t.id,t.id,"",e.comments,"",t.className,e.headImgID,u.deleteControl())}`;i("#mp-post-lists").innerHTML+=n,e.hasReply&&y(t.id)}o(!0)}).catch(e=>{console.log("拉取评论失败")})}(window.location.pathname),function(){let e=JSON.parse(localStorage.getItem("mixxoPostCache"));null!=e&&(i("#mp-nick").value=e.nick,i("#mp-mail").value=e.mail,i("#mp-website").value=e.website,b())}(),i(".mixxo-user-info").addEventListener("input",t=>{let n=t.target;n.value,e(0,n.id)}),i("#mp-comment").addEventListener("focusin",e=>{e.target.classList.add("mp-comment-minHeight")}),i("#mp-comment").addEventListener("blur",e=>{e.target.classList.remove("mp-comment-minHeight")});let t=()=>{i("#mp-comment").setAttribute("data-placeholder","留言..."),i("#mp-comment + label > span").innerText=2e3};t(),i("#mp-comment").addEventListener("input",e=>{if(e.target.parentNode.children[1].children[0].innerText=2e3-e.target.innerText.length,""!==e.target.innerText?e.target.setAttribute("data-placeholder",""):t(),e.target.innerText.length>2e3){let t=e.target.innerText;t.slice(0,2e3),t.slice(2e3)}});i("#mp-success-tips").addEventListener("animationend",e=>{i("#mp-success-tips").classList.remove("mp-success-tips")},!1);let n=window.location.pathname;i("#mp-post").addEventListener("click",e=>{function t(){switch(i(".mixxo-post").getAttribute("type")){case"reply":let e=i(".mixxo-post").getAttribute("parent-id"),t=i(".mixxo-post").getAttribute("re");d(s,r,l,c,e,md5(r),t,g());break;case"comment":m(s,r,l,c,n,md5(r),p,g())}}let s=i("#mp-nick").value,r=i("#mp-mail").value,l=i("#mp-website").value,c=i("#mp-comment").innerText.replace(/\n|\n\r|\r/g,"<br>"),p=[],g=function(){let e=i(".mixxo-post"),t=i("#mp-comment"),n=i("#mp-success-tips"),a=i(".mp-reply-tips"),o=i("#mp-comment + label > span");"reply"===e.getAttribute("type")&&(e.setAttribute("type","comment"),e.classList.remove("mixxo-post-reply"),i("#mp-overlay").classList.remove("mp-overlay"),a.style.display="",a.innerHTML=""),t.innerText="",o.innerText=2e3,n.classList.add("mp-success-tips"),localStorage.setItem("mixxoPostCache",'{"nick":"'+s+'","mail":"'+r+'","website":"'+l+'"}')};switch(!0){case""===s:i("#mp-nick").focus();break;case""===r:i("#mp-mail").focus();break;case""===c:i("#mp-comment").focus();break;default:s===a?!0===u.getCurrentUser()?t():(function(e,t,n){s===a&&AV.User.logIn(t,n).then(e=>{localStorage.removeItem("mixxoPostCache"),u.init(),console.log("登录成功"),i("#mp-mail").value="",i("#mp-website").value=""},e=>{})}(0,r,l),o(!0)):t()}})}()};return e}(window.mixxoPost||{});